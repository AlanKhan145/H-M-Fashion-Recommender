<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lesson — Flashcards</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Quicksand:wght@400;600;700&display=swap');
    body{ font-family:'Quicksand','Noto Sans JP',sans-serif; background:#f8fafc; }
    .jp{ font-family:'Noto Sans JP',sans-serif; }
    .gradient-text{ background:linear-gradient(135deg,#2563eb,#9333ea); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }

    /* Flashcard flip */
    .flip-card{ background:transparent; perspective:1000px; height:210px; }
    .flip-card-inner{
      position:relative; width:100%; height:100%;
      text-align:center; transition:transform .6s;
      transform-style:preserve-3d; cursor:pointer;
    }

    /* ❌ bỏ hover flip để không “ăn click” */
    .flip-card:hover .flip-card-inner{ transform:none; }

    /* ✅ flip bằng click */
    .flip-card.is-flipped .flip-card-inner{ transform:rotateY(180deg); }

    .flip-card-front,.flip-card-back{
      position:absolute; width:100%; height:100%;
      backface-visibility:hidden;
      display:flex; flex-direction:column;
      justify-content:center; align-items:center;
      border-radius:1.6rem;
      padding:1.4rem;
      box-shadow:0 6px 14px -8px rgb(0 0 0 / .18);
    }
    .flip-card-front{ background:white; border:1px solid #e2e8f0; }
    .flip-card-back{ background:#3b82f6; color:white; transform:rotateY(180deg); }

    .loader{
      border:3px solid #f3f3f3; border-radius:50%;
      border-top:3px solid #3498db; width:22px; height:22px;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body class="text-slate-800 antialiased">

<header class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-50">
  <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
    <div class="flex items-center gap-3">
      <div class="bg-gradient-to-tr from-blue-600 to-indigo-600 text-white p-2.5 rounded-xl shadow-lg">
        <i class="fas fa-clone text-xl"></i>
      </div>
      <div>
        <h1 class="text-xl font-bold tracking-tight">Flashcards</h1>
        <p id="subTitle" class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">—</p>
      </div>
    </div>

    <nav class="hidden md:flex items-center gap-4 text-sm font-bold text-slate-600">
      <a href="index.html" class="hover:text-blue-600 transition"><i class="fas fa-arrow-left mr-2"></i>Danh sách</a>
      <a id="goQuiz" href="#" class="hover:text-indigo-600 transition"><i class="fas fa-flask mr-2"></i>Quiz</a>
      <button id="btnVoices" class="px-4 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 transition">
        Voice
      </button>
    </nav>
  </div>
</header>

<main class="max-w-6xl mx-auto px-6 py-10">

  <section class="text-center mb-8">
    <h2 id="lessonTitle" class="text-4xl md:text-5xl font-extrabold mb-2 gradient-text">—</h2>
    <p id="lessonDesc" class="text-slate-500 max-w-2xl mx-auto">—</p>
  </section>

  <section class="bg-white p-6 rounded-[2rem] shadow-xl border border-slate-100 mb-8">
    <div class="grid md:grid-cols-4 gap-4 items-end">
      <div>
        <label class="text-xs font-bold text-slate-500 uppercase tracking-widest">Tìm</label>
        <input id="qInput" class="mt-2 w-full p-3 rounded-xl border border-slate-200 bg-slate-50" placeholder="term/meaning/reading..." />
      </div>

      <div>
        <label class="text-xs font-bold text-slate-500 uppercase tracking-widest">Sắp xếp</label>
        <select id="sortSelect" class="mt-2 w-full p-3 rounded-xl border border-slate-200 bg-slate-50 font-bold">
          <option value="new">Mới nhất</option>
          <option value="level_asc">Level tăng</option>
          <option value="level_desc">Level giảm</option>
          <option value="term_asc">A → Z</option>
          <option value="term_desc">Z → A</option>
        </select>
      </div>

      <div class="flex gap-3 items-center">
        <label class="inline-flex items-center gap-2 text-sm font-bold text-slate-600">
          <input id="onlyStarred" type="checkbox" class="accent-blue-600" /> Chỉ ⭐
        </label>
        <label class="inline-flex items-center gap-2 text-sm font-bold text-slate-600">
          <input id="onlyUnlearned" type="checkbox" class="accent-indigo-600" /> Chưa học
        </label>
      </div>

      <div class="flex gap-2">
        <button id="btnLoad" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition shadow-md">
          Tải từ
        </button>
        <a href="admin_add_items.html" class="px-4 py-3 rounded-xl border border-slate-200 bg-white font-bold hover:bg-slate-50 transition">
          Admin
        </a>
      </div>
    </div>

    <div class="mt-5 flex items-center justify-between">
      <div id="loading" class="hidden items-center gap-2 text-slate-500">
        <div class="loader"></div><span class="text-sm font-bold">Đang tải...</span>
      </div>
      <div class="text-sm text-slate-500">Tổng: <b id="countText">0</b> cards</div>
    </div>

    <div class="mt-4">
      <label class="text-xs font-bold text-slate-500 uppercase tracking-widest">Voice</label>
      <select id="voiceSelect" class="mt-2 w-full p-3 rounded-xl border border-slate-200 bg-slate-50 font-bold"></select>
      <div class="mt-2 flex gap-2">
        <button id="btnAutoPick" class="px-4 py-2 rounded-xl bg-slate-900 text-white font-bold">Auto pick</button>
        <button id="btnTest" class="px-4 py-2 rounded-xl bg-white border border-slate-200 font-bold">Test</button>
      </div>
    </div>
  </section>

  <section>
    <div id="cards" class="grid grid-cols-2 md:grid-cols-4 gap-6"></div>
  </section>

</main>

<div id="toast" class="fixed bottom-8 right-8 bg-slate-900 text-white px-6 py-3 rounded-2xl shadow-2xl transition-all transform translate-y-20 opacity-0 pointer-events-none z-[100]">
  <span id="toastMsg"></span>
</div>

<script src="assets/app.js"></script>
<script>
  // ----- helpers -----
  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function getParam(name){
    const u = new URL(location.href);
    return u.searchParams.get(name);
  }

  // ----- TTS -----
  let voices = [];
  let currentVoice = null;

  function loadVoices(){
    voices = window.speechSynthesis.getVoices() || [];
    const sel = document.getElementById("voiceSelect");
    sel.innerHTML = "";
    voices.forEach((v, idx)=>{
      const opt = document.createElement("option");
      opt.value = idx;
      opt.textContent = `${v.name} — ${v.lang}`;
      sel.appendChild(opt);
    });
    sel.onchange = ()=> currentVoice = voices[+sel.value];
  }

  function autoPickVoice(lang){
    if(!voices.length) loadVoices();
    const prefer = (lang||"").toLowerCase();
    const found = voices.find(v => (v.lang||"").toLowerCase().startsWith(prefer))
               || voices.find(v => (v.name||"").toLowerCase().includes(prefer))
               || voices[0];
    currentVoice = found || null;
    if(currentVoice){
      const idx = voices.indexOf(currentVoice);
      document.getElementById("voiceSelect").value = String(Math.max(0, idx));
      toast("Voice: " + currentVoice.name);
    }
  }

  function speak(text, lang){
    if(!("speechSynthesis" in window)) return toast("Trình duyệt không hỗ trợ TTS.");
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang || "en";
    if(currentVoice) u.voice = currentVoice;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }

  window.speechSynthesis.onvoiceschanged = loadVoices;

  // ----- state -----
  const lessonId = getParam("lesson_id");
  if(!lessonId) toast("Thiếu lesson_id");

  let lessonLang = "en";

  // chống double-click nói liên tục
  let lastSpeakAt = 0;

  async function loadLessonInfo(){
    const lesson = await apiGet(`/lessons/${encodeURIComponent(lessonId)}`);
    lessonLang = lesson.lang;

    document.getElementById("lessonTitle").textContent = lesson.title;
    document.getElementById("lessonDesc").textContent = lesson.description || "—";
    document.getElementById("subTitle").textContent = `${lesson.lang} • lesson #${lesson.id} • slug: ${lesson.slug}`;
    document.getElementById("goQuiz").href = `quiz.html?lesson_id=${encodeURIComponent(lesson.id)}`;

    autoPickVoice(lessonLang);
  }

  function renderCards(items){
    document.getElementById("countText").textContent = String(items.length);
    const cards = document.getElementById("cards");
    cards.innerHTML = "";

    items.forEach(v=>{
      // wrapper để đặt nút nghe OUTSIDE card (bấm luôn được)
      const wrap = document.createElement("div");
      wrap.className = "relative";

      const card = document.createElement("div");
      card.className = "flip-card";

      card.innerHTML = `
        <div class="flip-card-inner">
          <div class="flip-card-front">
            <div class="text-3xl font-extrabold mb-2 ${lessonLang==='ja'?'jp':''}">${esc(v.term)}</div>
            <div class="text-xs font-bold text-slate-400 uppercase tracking-widest">${esc(v.reading || "")}</div>

            <div class="mt-4 flex gap-2">
              <button class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs font-bold" data-act="learned">
                ${v.learned ? "Đã học" : "Chưa học"}
              </button>

              <button class="px-3 py-2 rounded-xl ${v.starred ? "bg-yellow-400" : "bg-slate-100"} text-slate-900 text-xs font-extrabold" data-act="star">
                ⭐
              </button>
            </div>
          </div>

          <div class="flip-card-back">
            <i class="fas fa-lightbulb text-2xl mb-2"></i>
            <div class="text-lg font-extrabold text-center">${esc(v.meaning)}</div>
            <div class="text-xs opacity-90 mt-2 text-center">${esc(v.example || "")}</div>
          </div>
        </div>
      `;

      // ✅ nút nghe ngoài card
      const btnSpeak = document.createElement("button");
      btnSpeak.className =
        "absolute top-3 right-3 z-20 px-3 py-2 rounded-xl bg-slate-900 text-white text-xs font-bold shadow-lg hover:bg-slate-800 transition";
      btnSpeak.innerHTML = `<i class="fas fa-volume-up"></i>`;
      btnSpeak.title = "Nghe phát âm";
      btnSpeak.onclick = (e)=>{
        e.stopPropagation();
        speak(v.term, lessonLang);
      };

      // ✅ click lật card => auto speak khi lật sang mặt sau
      card.onclick = ()=>{
        const willFlipToBack = !card.classList.contains("is-flipped");
        card.classList.toggle("is-flipped");

        if(willFlipToBack){
          const now = Date.now();
          if(now - lastSpeakAt > 250){
            lastSpeakAt = now;
            speak(v.term, lessonLang);
          }
        }
      };

      // learned/star (không lật)
      card.querySelector('[data-act="learned"]').onclick = async (e)=>{
        e.stopPropagation();
        try{
          await apiPatch(`/items/${v.id}`, { learned: !v.learned });
          toast("Cập nhật learned ✅");
          loadItems();
        }catch(err){ toast("Lỗi: " + err.message); }
      };

      card.querySelector('[data-act="star"]').onclick = async (e)=>{
        e.stopPropagation();
        try{
          await apiPatch(`/items/${v.id}`, { starred: !v.starred });
          toast("Cập nhật ⭐");
          loadItems();
        }catch(err){ toast("Lỗi: " + err.message); }
      };

      wrap.appendChild(card);
      wrap.appendChild(btnSpeak);
      cards.appendChild(wrap);
    });
  }

  async function loadItems(){
    const q = document.getElementById("qInput").value.trim();
    const sort = document.getElementById("sortSelect").value;
    const onlyStarred = document.getElementById("onlyStarred").checked;
    const onlyUnlearned = document.getElementById("onlyUnlearned").checked;

    const loading = document.getElementById("loading");
    loading.classList.remove("hidden"); loading.classList.add("flex");

    const params = new URLSearchParams({ sort, limit:"500" });
    if(q) params.set("q", q);
    if(onlyStarred) params.set("only_starred", "true");
    if(onlyUnlearned) params.set("only_unlearned", "true");

    try{
      const items = await apiGet(`/lessons/${encodeURIComponent(lessonId)}/items?` + params.toString());
      renderCards(items);
      localStorage.setItem("lastLessonId", String(lessonId));
    }catch(e){
      toast("Lỗi tải items: " + e.message);
    }finally{
      loading.classList.add("hidden"); loading.classList.remove("flex");
    }
  }

  // events
  document.getElementById("btnLoad").onclick = loadItems;
  document.getElementById("btnAutoPick").onclick = ()=> autoPickVoice(lessonLang);
  document.getElementById("btnTest").onclick = ()=> speak(lessonLang==="ja" ? "わたしはがくせいです。" : "Hello, let's study.", lessonLang);
  document.getElementById("btnVoices").onclick = ()=> { loadVoices(); toast("Đã tải voice"); };

  loadVoices();
  (async ()=>{
    await loadLessonInfo();
    await loadItems();
  })();
</script>
</body>
</html>
